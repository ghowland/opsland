name: Example 0 Bundle


# HTTP root for this bundle.  Allows multiple bundles to coexist on the same server.  Hostnames are not considered, all paths are global once they reach OpsLand
#NOTE: No leading / for the root.  If mounted at "/" then leave this empty
root: ""


# Git repos we want to sync
git: {}


# Put all our data cache in here, 1 file per Cache Key to make it simple and glob them all back up
path:
  # Cache results from CLI-JSON runs.  This will get as big as the content times the number of max items if they are a queue.
  cache: ~/.cache/opsland/example0/cache/{key}

  # Keep summary separate, just to be more organized on disk.  In memory, Cache and Summary data are in the same Bundle cache bucket
  summary: ~/.cache/opsland/example0/summary/{key}

  # Login static information.  Not using Okta 
  login_sessions: ~/.secure/opsland/logins.json

  # If no directory is specified, use this one for `execute.` 
  default_execute_dir: /mnt/d/_OpsLand/opsland-example


# This is how we authenticate into this Bundle
auth:
  # Auth using cookies, compare username and token cookie to our cached data to get their authed session
  cookie:
    username: username
    token: token

    # Use this cache to verify the username and token field
    cache: execute.api.login.{session.username}

    # Put this data into the user session, so it is always available to us
    session:
      cache:
        execute.api.site_user.{session.username}:
          email: [email]
          name_first: [name_first]
          title: [title]


# # Running commands while waiting on shell commands is no good, so everything should be done in a deferred manner.  Scheduled or as a Job execution.  Same thing ultimately
# schedule:
#   period:
#     mtr:
#       command: /mnt/d/_OpsLand/opsland-example/opsland_example.py go
#       period: 15s
#       # store: single
#       store: queue
#       max: 20

#     deep:
#       command: /mnt/d/_OpsLand/opsland-example/opsland_example.py deep
#       period: 15s

#     2x:
#       command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/input_2x.json 2x
#       period: 15s
#       input_path: /tmp/opsland/input_2x.json
#       input:
#         schedule.period.mtr:
#           mtr: [-1, mtr, -1]


# These commands will be executed at specific times, such as during an HTTP request
execute:
  # This bucket helps organize different things we want to execute, but other things could potentially call things from api
  api:
    # CRUD: User
    site_user:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/crud_user.json crud_user
      input_path: /tmp/opsland/crud_user.json
      input:
        request:
          record_id: [username]

      # If this exists, we use it to save all our cache data to unique files.  They will also be loaded uniquely
      unique_key: "{username}"

    # Login for users
    login:
      #TODO(geoff): Need to pass it as STDIN, or make totally unique files
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/site_login_{uuid}.json site_login
      input_path: /tmp/opsland/site_login_{uuid}.json
      input:
        # Pass through our request data
        request:
          record_id: [username]

        # Fetch our user data for this use as well
        execute.api.site_user.{request.username}:
          matched: []

      # If this exists, we use it to save all our cache data to unique files.  They will also be loaded uniquely
      unique_key: "{username}"

    # Site Editor: Creates and edits widgets
    site_editor:
      #TODO(geoff): Need to pass it as STDIN, or make totally unique files
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/site_editor_{uuid}.json site_editor
      input_path: /tmp/opsland/site_editor_{uuid}.json
      input:
        # Pass through our request data
        request:
          record_id: [widget]

      # If this exists, we use it to save all our cache data to unique files.  They will also be loaded uniquely
      unique_key: "{widget_id}"

    # Site Editor: Dynamic
    site_editor_dynamic:
      #TODO(geoff): Need to pass it as STDIN, or make totally unique files
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/site_editor_dynamic_{uuid}.json site_editor_dynamic
      # dir: ~/work/opsland-example/
      input_path: /tmp/opsland/site_editor_dynamic_{uuid}.json
      input:
        # Pass through our request data
        request:
          record_id: [widget]

      # If this exists, we use it to save all our cache data to unique files.  They will also be loaded uniquely
      unique_key: "{widget_id}"

    # Retrieves the page data for this given page
    site_page:
      #TODO(geoff): Need to pass it as STDIN, or make totally unique files
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/site_page_{uuid}.json site_page
      # dir: ~/work/opsland-example/
      input_path: /tmp/opsland/site_page_{uuid}.json
      input:
        # Pass through our request data
        request:
          record_id: [uri]

        execute.api.site_page.{request.site_page_uri}:
          stored: []

      # If this exists, we use it to save all our cache data to unique files.  They will also be loaded uniquely
      unique_key: "{uri}"
    
    # Loads the static Site Page Content
    site_page_example_render:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py site_page_example_render
    
    # Loads the static Site Tags
    space_widget_tags:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py space_widget_tags
    
    # Loads the Map from Widget to HTML Jinja
    #TODO:RENAME: space_map_widget_html
    space_map_widget_html:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py space_map_widget_html

    # New: Spec: Page Content are things like: icon, button, text, section, page, etc.
    #TODO:RENAME: space_widget_spec
    space_widget_spec:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py space_widget_spec
    
    # Loads Page Data per page
    space_page_data:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/space_page_data_{uuid}.json space_page_data
      input_path: /tmp/opsland/space_page_data_{uuid}.json
      input:
        # Pass through our request data
        request:
          record_id: [uri]

        execute.api.space_page_data.{request.site_page_uri}:
          last_version: []

      # If this exists, we use it to save all our cache data to unique files.  They will also be loaded uniquely
      unique_key: "{uri}"

    space_style:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/space_style_{uuid}.json space_style
      input_path: /tmp/opsland/space_style_{uuid}.json
      input:
        # Pass through our request data
        request:
          record_id: [uri]

        execute.api.space_style:
          style_data: []
    
    space_edit_widget:
      command: /mnt/d/_OpsLand/opsland-example/opsland_example.py -i /tmp/opsland/space_edit_widget_{uuid}.json space_edit_widget
      input_path: /tmp/opsland/space_edit_widget_{uuid}.json
      input:
        # Pass through our request data
        request:
          record_id: [uri]

        execute.api.space_page_data.{request.site_page_uri}:
          last_version: []
        

# Static content we can load into usage, like cache, but we dont store it based on execution, we just load it and reload if updated
static:
  site_page.try00: /mnt/d/_OpsLand/opsland-example/data/site_page/try00.yaml
  site_page.try01: /mnt/d/_OpsLand/opsland-example/data/site_page/try00.yaml


# # Every time we write data, we have the opportunity to summarize data that is not single (ex: queue)
# summary:
#   # Will be found in Cache with the prefix "summary.schedule.period.mtr", but with specific things being like: `summary.schedule.period.mtr.average` and then 
#   #   their summary being: `summary.schedule.period.mtr.average.max` for the max value
#   schedule.period.mtr:
#     # Final values will be coerced to float values.  Creates: min, max, last, average, mean, stddev, timeseries
#     type: float

#     # If group_by exists, we will make N results.  1 per each group found, this will append an additional string, so you need to know how to reference this
#     fields:
#       hop_count: [hop_count]
#       average: [mtr_last, average]
#       last: [mtr_last, last]
#       best: [mtr_last, best]
#       worst: [mtr_last, worst]
#       loss: [mtr_last, loss]


# HTTP Routing and Rendering.  All paths overlay over the `root`
http:
  # POST
  post:
    # Login
    api/login:
      template: returns/api_login.html.j2
      execute: execute.api.login

    api/site_editor:
      template: returns/api_site_editor_widget_target.html.j2
      execute: execute.api.site_editor

    # Widget Reformat
    api/site_editor_dynamic:
      template: returns/api_site_editor_widget_target.html.j2
      execute: execute.api.site_editor_dynamic

    # Reload the Sidebar
    api/site_editor_sidebar:
      template: returns/api_site_sidebar_edit_widget.html.j2
      execute: execute.api.site_editor_dynamic
      
      cache:
        execute.api.site_page.{uri}:
          input: [input]
          output: [output]
          widget_data: [widget_data]
          widget_id: [widget_id]
          widget_type: [widget_type]

    # CRUD: User
    api/site_user:
      execute: execute.api.site_user

    #TODO: Make built in easy functions for modals and stuff that render server-side and the page doesnt need to know about them at all...  Tool box full of these...  Calendar, time range, etc
    modal/yes_no:
      template: returns/modal_yes_no.html.j2

    # Site Page Data
    api/site_page_sidebar:
      template: returns/api_site_page_edit_sidebar_widget.html.j2
      execute: execute.api.site_page

    # Site Page Re-render full page
    api/site_page_render_full:
      template: component/site_page_full.html.j2
      execute: execute.api.site_page
    
    # New: Re-render the Sidebar after a change
    api/space_editor_sidebar:
      template: component/site_editor/widget_page_edit_sidebar_widget.html.j2
      execute: execute.api.space_page_data

      cache:
        execute.api.space_page_data.{site_page_uri}:
          site_page: []

        # space_widget_spec
        execute.api.space_widget_spec:
          widget_specs: []

        # space_map_widget_html
        execute.api.space_map_widget_html:
          map_widget_html: []

        execute.api.space_style:
          space_style: []


    # New: Re-render the Full Page after a change
    api/space_editor_render:
      template: component/site_render/page_render.html.j2
      execute: execute.api.space_page_data

      cache:
        execute.api.space_page_data.{site_page_uri}:
          site_page: []

        execute.api.space_widget_spec:
          widget_specs: []
        
        execute.api.space_map_widget_html:
          map_widget_html: []

        execute.api.space_style:
          space_style: []

    api/space_style:
      template: component/site_style.html.j2
      execute: execute.api.space_style

    api/space_edit_widget:
      # template: component/site_style.html.j2
      execute: execute.api.space_edit_widget


  # GET
  get:
    # Refresh these to update static content
    get/space_widget_spec:
      execute: execute.api.space_widget_spec
    get/space_map_widget_html:
      execute: execute.api.space_map_widget_html
    get/space_widget_tags:
      execute: execute.api.space_widget_tags

    # Dynamic version
    plan00:
      template: pages/site_page_render.html.j2
      cache:
        execute.api.space_page_data.plan00:
          site_page: []
        execute.api.space_widget_spec:
          widget_specs: []
        execute.api.space_map_widget_html:
          map_widget_html: []
        execute.api.space_widget_tags:
          site_page_tags: []

        execute.api.space_style:
          space_style: []

    # Paths
    site_editor:
      template: pages/site_editor.html.j2

      cache:
        execute.api.site_editor.{widget}:
          input: [input]

    # Paths
    site_editor_dynamic:
      template: pages/site_editor_dynamic.html.j2

      cache:
        execute.api.site_editor_dynamic.{widget}:
          input: [input]
          output: [output]
          widget_data: [widget_data]
          widget_id: [widget_id]
          widget_type: [widget_type]

    try00:
      template: pages/site_try_00.html.j2

      cache:
        execute.api.site_editor_dynamic.{widget}:
          input: [input]
          output: [output]
          widget_data: [widget_data]
          widget_id: [widget_id]
          widget_type: [widget_type]

        # execute.api.site_page.{uri}:
        #   site_page: []
      
        static.site_page.try00:
          page_widgets: [widgets]

    try01:
      template: pages/site_try_01.html.j2

      cache:
        # Each page gets it's own set of data
        execute.api.site_page.{uri}:
          site_page: []

          # List of our widget_ids (UUID)
          widgets: [widgets]

          # All the widget output as data, ready for Final Templating as one flat dict pool
          widget_output: [widget_output]

          # widget_id (UUID) of single widget we will be editing in edit_widget_spec
          edit_widget: [edit_widget]

          # Single set of data for Edit Templating as a single widget
          edit_widget_spec: [edit_widget_spec]

          # All the data we use as individeal inputs, needed to populate values of the edit_widget_spec
          widget_input: [widget_input]

    # Style stuff    
    site_style:
      template: pages/site_style.html.j2

      cache:
        execute.api.space_style:
          space_style: []

        execute.api.space_page_data.plan00:
          site_page: []
        execute.api.space_widget_spec:
          widget_specs: []
        execute.api.space_map_widget_html:
          map_widget_html: []
        execute.api.space_widget_tags:
          site_page_tags: []

    test:
      template: pages/generic_test.html.j2

    test2:
      template: pages/generic_test_flowbite.html.j2

    test3:
      template: pages/generic_test_flowbite2.html.j2

    test4:
      template: pages/generic_test_flowbite3.html.j2

    test5:
      template: pages/generic_test_flowbite4.html.j2

    test6:
      template: pages/generic_test_flowbite5.html.j2

    test7:
      template: pages/generic_test_flowbite6.html.j2

    test8:
      template: pages/generic_test_flowbite7.html.j2

    test9:
      template: pages/generic_test_flowbite8.html.j2

    test10:
      template: pages/generic_test_flowbite9.html.j2

    test11:
      template: pages/generic_test_flowbite10.html.j2

    test12:
      template: pages/generic_test_flowbite11.html.j2

    test13:
      template: pages/generic_test_flowbite12.html.j2

    site00:
      template: pages/generic_site_00.html.j2

    site01:
      template: pages/generic_site_01.html.j2

    site02:
      template: pages/generic_site_02.html.j2

    site03:
      template: pages/generic_site_03.html.j2

    site04:
      template: pages/generic_site_04.html.j2

    site05:
      template: pages/generic_site_05.html.j2

    site06:
      template: pages/generic_site_06.html.j2

    site07:
      template: pages/generic_site_07.html.j2

    site08:
      template: pages/generic_site_08.html.j2

    site09:
      template: pages/generic_site_09.html.j2

    site10:
      template: pages/generic_site_10.html.j2

    site11:
      template: pages/generic_site_11.html.j2

    site12:
      template: pages/generic_site_12.html.j2

    site13:
      template: pages/generic_site_13.html.j2

    site14:
      template: pages/generic_site_14.html.j2

    site15:
      template: pages/generic_site_15.html.j2

    site16:
      template: pages/generic_site_16.html.j2

    site17:
      template: pages/generic_site_17.html.j2

    site18:
      template: pages/generic_site_18.html.j2

    site19:
      template: pages/generic_site_19.html.j2

    site20:
      template: pages/generic_site_20.html.j2

    opsland/status:
      template: returns/opsland_status.html.j2

    # /login
    login:
      template: pages/site_login.html.j2

    # /logout
    logout:
      template: pages/site_logout.html.j2

    # /register
    register:
      template: pages/site_register.html.j2

    # /password-reset
    password-reset:
      template: pages/site_password_reset.html.j2

    # /social-proof
    social-proof:
      template: pages/example_social_proof.html.j2

    pricing:
      template: pages/example_pricing.html.j2

    team:
      template: pages/example_team.html.j2

    user-onboard:
      template: pages/example_user_onboard.html.j2

    testimonial:
      template: pages/example_testimonial.html.j2

    newsletter:
      template: pages/example_newsletter.html.j2

    newsletter2:
      template: pages/example_newsletter2.html.j2

    maintenance:
      template: pages/example_maintenance.html.j2

    account-recovery1:
      template: pages/example_account_recovery1.html.j2

    account-recovery2:
      template: pages/example_account_recovery2.html.j2

    account-recovery3:
      template: pages/example_account_recovery3.html.j2

    account-recovery4:
      template: pages/example_account_recovery4.html.j2

    account-recovery5:
      template: pages/example_account_recovery5.html.j2

    "500":
      template: pages/example_500.html.j2

    "404":
      template: pages/example_404.html.j2

    hero:
      template: pages/example_hero.html.j2

    feature:
      template: pages/example_feature.html.j2

    faq:
      template: pages/example_faq.html.j2

    customer-logos:
      template: pages/example_customer_logos.html.j2

    banner1:
      template: pages/example_banner1.html.j2

    banner2:
      template: pages/example_banner2.html.j2

    banner3:
      template: pages/example_banner3.html.j2

    banner4:
      template: pages/example_banner4.html.j2

    banner5:
      template: pages/example_banner5.html.j2

    cta:
      template: pages/example_cta.html.j2

    contact:
      template: pages/example_contact.html.j2

    content-sections:
      template: pages/example_content_sections.html.j2

    cookie-consent1:
      template: pages/example_cookie_consent1.html.j2

    cookie-consent2:
      template: pages/example_cookie_consent2.html.j2

    cookie-consent3:
      template: pages/example_cookie_consent3.html.j2

    cookie-consent4:
      template: pages/example_cookie_consent4.html.j2

    headers:
      template: pages/example_headers.html.j2

    footers:
      template: pages/example_footers.html.j2

    popup1:
      template: pages/example_popup1.html.j2

    popup2:
      template: pages/example_popup2.html.j2

    popup3:
      template: pages/example_popup3.html.j2

    popup4:
      template: pages/example_popup4.html.j2

    popup5:
      template: pages/example_popup5.html.j2

    # /user
    user:
      template: pages/site_user.html.j2

      cache:
        # schedule.period.deep:
        #   deep: []
        # In this way, selectors can be added right into the key to get from the cache.  This means we expect this data
        execute.api.site_user.{user}:
          user: []

      page: User
      page_group: Status
      breadcrumbs:
        - Any: /else
        - Old: /if
        - Day: /not


    # /user_list
    user_list:
      template: pages/site_user_list.html.j2

      cache:
        # In this way, selectors can be added right into the key to get from the cache.  This means we expect this data
        execute.api.site_user.*:
          users: []

      page: User
      page_group: Status
      breadcrumbs:
        - Any: /else
        - Old: /if
        - Day: /not

      data:
        # A table using a Dict of Dicts
        table_dict:
          # Payload output key
          user_list:
            cache: users
            key: []
            name: User
            element: user_table
            link: "/user?user=%(username)s"
            key_field: username
            fields:
              - email: Email
              - name_first: Name
            no_max_height: True
    

    # /status
    status:
      template: pages/generic_view.html.j2

      # Extract data from this Cache, to be used for rendering
      cache:
        schedule.period.mtr: 
          mtr: []
        schedule.period.2x:
          twox: []
        summary.schedule.period.mtr.best.timeseries:
          series_best: []
        summary.schedule.period.mtr.worst.timeseries:
          series_worst: []
        summary.schedule.period.mtr.loss.timeseries:
          series_loss: []
        summary.schedule.period.mtr.best.mean:
          series_mean: []

      page: Home
      page_group: Info
      breadcrumbs:
        - For: /else
        - The: /if
        - Win: /not

      data:
        # A table using a Dict of Dicts
        table_dict:
          # Payload output key
          table_data_dict:
            cache: mtr
            key: [-1, data_dict]
            name: Example Data 1
            element: generic_table
            link: "/example/%(_key)s"
            fields:
              - first: First
              - second: Second
            no_max_height: True

        # A table using a List of Dicts
        table_list:
          # Payload output key
          table_data_list:
            cache: mtr
            key: [-1, mtr]
            name: Hop
            element: generic_table
            link: "/example/%(target)s"
            link_field: index
            fields:
              - ip: IP
              - loss: Loss
              - sent: Sent
              - last: Last
              - average: Avg
              - best: Best
              - worst: Worse
              - stddev: StdDev
            no_max_height: True
        
        # Graphs.  Like like graphs, or scatter plots.  With Graph.js
        graph:
          best:
            label: Best ICMP in ms
            cache: series_best
            element: graph_best

          worst:
            label: Worst ICMP in ms
            cache: series_worst
            element: graph_worst

          loss:
            label: Loss in ICMP
            cache: series_loss
            element: graph_loss


# Site NavBar and User links.  Overlays over the `root`.
nav:
  bar:
    Home: /
    Info: /info
    Work: /work
    Status: /status
    Problems: /problem
  
  user:
    Status: /status
    Progress: /progress
    Work: /work
    Settings: /settings
    Sign Out: /logout

